<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jinhe.modules.system.dao.SysResourceMapper">

    <select id="selectPageAll" resultType="com.jinhe.modules.system.dto.SysResourceDTO">
       SELECT
        r.*,
        group_concat( DISTINCT CASE WHEN i.id IS NOT NULL THEN ( concat(i.id, '_', i.NAME, '_', i.display_name, '_', i.state ) ) ELSE '' END ) AS item
    FROM
        sys_resource r
        LEFT JOIN sys_resource_item i ON r.id = i.resource_id
        GROUP BY  r.id
    </select>
    <select id="listResource" resultType="com.jinhe.modules.system.dto.SysResourceDTO">
        SELECT
        sr.*,
        group_concat(
        DISTINCT
        CASE

        WHEN sri.id IS NOT NULL THEN
        ( concat( sri.id, '_', sri.`name`, '_', sri.display_name, '_', sri.state ) ) ELSE ''
        END
        ) AS resourceItemIds
        FROM
        sys_permission sp
        LEFT JOIN sys_permission_item spi ON spi.permission_id = sp.id
        LEFT JOIN sys_resource sr ON sr.id = sp.resource_id and sr.type = 1
        LEFT JOIN sys_resource_item sri ON sri.id = spi.resource_item_id
        LEFT JOIN sys_organ_role sor ON sor.role_id = sp.role_id
        LEFT JOIN sys_user_organ suo ON suo.organ_id = sor.organ_id
        <if test=" userId != null and  userId !=''">
            WHERE suo.user_id=#{userId} and sr.state=1
        </if>
        GROUP BY
        sr.id
    </select>
    <select id="listResourceAdmin" resultType="com.jinhe.modules.system.dto.SysResourceDTO">
        SELECT
        sr.*,
        group_concat(
        DISTINCT
        CASE

        WHEN sri.id IS NOT NULL THEN
        ( concat( sri.id, '_', sri.`name`, '_', sri.display_name, '_', sri.state ) ) ELSE ''
        END
        ) AS resourceItemIds
        FROM
        sys_resource sr
        LEFT JOIN sys_resource_item sri ON sri.resource_id = sr.id
        <where>
            sr.STATE =1 and
            <foreach collection="types" item="type" separator=" or " open="(" close=")">
                sr.type =#{type}
            </foreach>
        </where>

        GROUP BY
        sr.id
    </select>
    <select id="listByRole" resultType="com.jinhe.modules.system.dto.SysResourceDTO">
        SELECT
        sr.*,
        group_concat(
        DISTINCT
        CASE

        WHEN sri.id IS NOT NULL THEN
        ( concat( sri.id, '_', sri.`name`, '_', sri.display_name, '_', sri.state ) ) ELSE ''
        END
        ) AS resourceItemIds
        FROM
        sys_permission sp
        LEFT JOIN sys_permission_item spi ON spi.permission_id = sp.id
        LEFT JOIN sys_resource sr ON sr.id = sp.resource_id
        AND sr.type <![CDATA[ <>  ]]> 2
        LEFT JOIN sys_resource_item sri ON sri.id = spi.resource_item_id
        WHERE
        sp.role_id = #{roleId}
        GROUP BY
        sr.id
    </select>

</mapper>
